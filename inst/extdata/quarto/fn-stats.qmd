---
title: "Historical Data"
execute:
  echo: false
format: 
  html:
    fig-width: 8
    fig-height: 4
    code-fold: false
---

```{r load-pkg, echo = FALSE, message = FALSE}
library (githist)
library (lubridate)
```
This page includes several graphs providing insight into the historical
development of the package.

## Data on individual functions

This plot shows time series for the development of the following measures for each function in the package:

- `doclines` = Numbers of lines of documentation per function.
- `npars` = Numbers of parameters per function.
- `loc` = Numbers of lines of code per function.
- `ext_calls` = Numbers calls made to external functions.

The selector below allows any one of these variables to be selected and
plotted. Results in each case are displayed as both median and median values
per function, along with the sum over all functions within the package. These
"sum" values are arbitrarily rescaled for visual display on similar scales to
the other measures.

```{r load-data}
dat <- readRDS ("results.Rds")
```
```{r stats-data}
cols <- names (dat$stats) [which (!names (dat$stats) %in% c ("package", "version"))]
stats <- dat$stats [, cols]
stats$date <- lubridate::ymd (strftime (stats$date, "%y-%m-%d"))
index <- which (stats$measure == "sum")
stats$npars [index] <- stats$npars [index] / 100
stats$loc [index] <- stats$loc [index] / 100
stats$ext_calls [index] <- stats$ext_calls [index] / 20
stats$doclines [index] <- stats$doclines [index] / 20

stats <- tidyr::pivot_longer (stats, c ("doclines", "npars", "loc", "ext_calls"))
```

```{r ojs-in-stats, echo = FALSE}
ojs_define (stats_in = stats)
```
```{ojs stats-transpose-and-filter}
stats = {
    return transpose(stats_in).map(row => ({
        ...row,
        date: new Date(row.date)
    }));
}
viewof name = Inputs.radio(
    ["doclines", "npars", "loc", "ext_calls"],
    {
        value: "npars",
        label: "Variable:",
    }
)
statsFiltered = stats.filter(function(row) {
  return name.includes(row.name)
})
```

```{ojs stats-plot}
Plot.plot({
    style: `
        overflow: visible;
    `,
    marginLeft: 60,
    marginBottom: 50,
    x: {grid: true},
    y: {grid: true},
    marks: [
        Plot.ruleY([0]),
        Plot.lineY(
            statsFiltered,
            {
                x: "date",
                y: "value",
                stroke: "measure",
                fontSize: 18
            }
        ),
        Plot.text(
            statsFiltered,
            Plot.selectLast({
                x: "date",
                y: "value",
                z: "measure",
                text: "measure",
                textAnchor: "start",
                dx: 3,
                fontSize: 18
            })
        ),
        Plot.axisX(
            {
                fontSize: 14,
                label: "",
                labelArrow: false
            }
        ),
        Plot.axisX(
            {
                fontSize: 20,
                label: "Date",
                labelAnchor: "center",
                labelOffset: 40,
                ticks: []
            }
        ),
        Plot.axisY(
            {
                fontSize: 14,
                label: "",
                labelArrow: false
            }
        ),
        Plot.axisY(
            {
                fontSize: 24,
                label: "Value",
                labelAnchor: "center",
                labelOffset: 55,
                ticks: []
            }
        ),
    ]
})
```

## General data

This plot shows some general data.

```{r desc-data}
cols <- names (dat$desc_data) [which (!names (dat$desc_data) %in% c ("package"))]
desc <- dat$desc_data [, cols]
desc$date <- lubridate::ymd (strftime (desc$date, "%y-%m-%d"))

cols <- names (desc) [which (!names (desc) %in% c ("date"))]
desc <- tidyr::pivot_longer (
    desc,
    c ("n_aut", "n_ctb", "n_fns_tot", "n_fns_exp", "n_ext_pkgs", "base_calls")
)
names (desc) <- c ("date", "desc_variable", "value")
```

```{r ojs-in-desc, echo = FALSE}
ojs_define (desc_in = desc)
```

```{ojs desc-transpose-and-filter}
desc = {
    return transpose(desc_in).map(row => ({
        ...row,
        date: new Date(row.date)
    }));
}
viewof desc_variable = Inputs.radio(
    ["n_aut", "n_ctb", "n_fns_tot", "n_fns_exp", "n_ext_pkgs", "base_calls"],
    {
        value: "n_fns_tot",
        label: "Variable:",
    }
)
descFiltered = desc.filter(function(row) {
  return desc_variable.includes(row.desc_variable)
})
```

```{ojs desc-plot}
Plot.plot({
    style: `
        overflow: visible;
    `,
    marginLeft: 60,
    marginBottom: 50,
    x: {grid: true},
    y: {grid: true},
    marks: [
        Plot.ruleY([0]),
        Plot.lineY(
            descFiltered,
            {
                x: "date",
                y: "value",
                fontSize: 18
            }
        ),
        Plot.axisX(
            {
                fontSize: 14,
                label: "",
                labelArrow: false
            }
        ),
        Plot.axisX(
            {
                fontSize: 20,
                label: "Date",
                labelAnchor: "center",
                labelOffset: 40,
                ticks: []
            }
        ),
        Plot.axisY(
            {
                fontSize: 14,
                label: "",
                labelArrow: false
            }
        ),
        Plot.axisY(
            {
                fontSize: 24,
                label: "Value",
                labelAnchor: "center",
                labelOffset: 55,
                ticks: []
            }
        ),
    ]
})
```
